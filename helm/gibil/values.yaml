common:
  app: gibil
  shortname: gibil
  team: ror
  ingress:
    trafficType: public
  service:
    externalPort: 80
    internalPort: 8080
  container:
    image: <+artifacts.primary.image>
    imagePullPolicy: Always
    cpu: 2
    memory: 2560
    securityContext:
      runAsUser: 1000
      runAsGroup: 1000
      fsGroup: 1000
    volumeMounts:
      - mountPath: /etc/application-config
        name: application-config
        readOnly: true
      - name: logs
        mountPath: /app/logs
    volumes:
      - configMap:
            defaultMode: 420
            name: gibil-application
        name: application-config
      - name: logs
        emptyDir: {}
    probes:
      enabled: true
      spec:
        startupProbe:
          tcpSocket:
            port: 8080
          initialDelaySeconds: 10
          periodSeconds: 1
          timeoutSeconds: 1
          failureThreshold: 300
        readinessProbe:
          httpGet:
            path: /actuator/health/readiness
            port: 8080
          initialDelaySeconds: 45
          periodSeconds: 10
          timeoutSeconds: 10
          failureThreshold: 3
          successThreshold: 1
        livenessProbe:
          httpGet:
            path: /actuator/health/liveness
            port: 8080
          initialDelaySeconds: 30
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 3

  initContainers:
    - name: create-log-dirs
      image: busybox:latest
      volumeMounts:
        - name: logs
          mountPath: /app/logs
      securityContext:
        runAsUser: 1000
        runAsGroup: 1000
        allowPrivilegeEscalation: false
        runAsNonRoot: true
        capabilities:
          drop: ["ALL"]
        seccompProfile:
          type: RuntimeDefault
      command:
        - sh
        - -c
        - |
          mkdir -p /app/logs/errors
          mkdir -p /app/logs/general
          mkdir -p /app/logs/secrets
          mkdir -p /app/logs/serviceJourneys
          chmod -R 755 /app/logs
          echo "Log directories created:"
          ls -la /app/logs/